# V1 Progress

The following V1 steps are already completed in this repository:

- [x] CLI scaffold exists with core commands: `--init`, `run`, `status`, `plan`, `worktrees`, `--version`, and `--help`.
- [x] `scriptorium --init` is implemented.
- [x] Init validates preconditions: target must be a git repository and must not already have a `scriptorium/plan` branch.
- [x] Init creates the orphan `scriptorium/plan` branch and writes planning files/directories: `areas/`, `tickets/open/`, `tickets/in-progress/`, `tickets/done/`, `decisions/`, and `spec.md` placeholder.
- [x] Init creates the initial commit on the plan branch (`scriptorium: initialize plan branch`).
- [x] Runtime config support exists via `scriptorium.json` with defaults for missing values.
- [x] Model-to-harness routing is implemented (`claude-*` -> `claude-code`, `codex-*`/`gpt-*` -> `codex`, otherwise `typoi`).
- [x] Test coverage exists for init behavior and config loading/routing (`tests/test_scriptorium.nim`).
- [x] `make test` runs the Nim test files (`tests/test_*.nim`).
- [x] CI is wired to run tests on push and pull request (`.github/workflows/build.yml`).

## Remaining Steps To Reach V1 (Detailed And Testable)

- [x] `V1-01` Create `src/scriptorium/orchestrator.nim` with a public `runOrchestrator*(repoPath: string)` entry point. Test: `nim check src/scriptorium/orchestrator.nim`.
- [x] `V1-02` Wire `cmdRun()` in `src/scriptorium.nim` to call `runOrchestrator(getCurrentDir())`. Test: `nim r src/scriptorium.nim run` no longer prints "not yet implemented".
- [x] `V1-03` Start an HTTP MCP server inside the run loop using config endpoint values. Test: integration test can connect to the configured local MCP endpoint.
- [x] `V1-04` Add event loop tick + idle sleep for orchestrator when no work exists. Test: run command stays alive for N seconds without crashing.
- [x] `V1-05` Add graceful shutdown for SIGINT/SIGTERM. Test: send SIGINT and assert clean exit code with no corrupted plan state.

- [x] `V1-06` Implement `spec.md` loading from `scriptorium/plan` branch worktree. Test: missing `spec.md` fails with clear error.
- [x] `V1-07` Detect "areas missing" condition from `/areas` directory. Test: empty areas directory triggers architect path once.
- [x] `V1-08` Add Architect invocation harness call using configured architect model. Test: mocked architect call receives spec text.
- [x] `V1-09` Persist generated area files and commit through orchestrator. Test: `git log` on plan branch contains area creation commit.
- [x] `V1-10` Make area creation idempotent (no duplicate rewrites when unchanged). Test: second run with same output creates no new commit.

- [x] `V1-11` Detect areas with zero open/in-progress tickets. Test: area with existing open ticket is skipped.
- [x] `V1-12` Add Manager invocation harness call per eligible area. Test: mocked manager is called once per eligible area.
- [x] `V1-13` Persist manager-created tickets into `tickets/open/` with stable IDs. Test: ticket filenames are unique and monotonic.
- [x] `V1-14` Commit ticket creation via orchestrator-only commit path. Test: commit author/message matches orchestrator policy.
- [x] `V1-15` Make ticket creation idempotent for unchanged manager output. Test: rerun does not duplicate tickets.

- [x] `V1-16` Implement oldest-open-ticket selection logic. Test: selector returns lexicographically oldest open ticket ID.
- [x] `V1-17` Move selected ticket `open/ -> in-progress/` in one commit. Test: after move, ticket exists in exactly one state directory.
- [x] `V1-18` Create and register code worktree for assigned ticket. Test: `git worktree list` includes ticket branch path.
- [x] `V1-19` Add cleanup path for finished/reopened tickets to remove stale worktrees. Test: closed ticket worktree is removed.

- [x] `V1-20` Launch Coding Agent with ticket context (goal, acceptance criteria, notes). Test: mocked agent receives expected payload.
- [x] `V1-21` Implement MCP `submit_pr` tool handling and enqueue merge request metadata. Test: MCP tool call creates queue entry.
- [x] `V1-22` Implement merge queue single-flight processing (one merge job at a time). Test: second queued item waits until first completes.
- [x] `V1-23` Merge `master` into ticket branch before tests. Test: integration test confirms merge step runs before `make test`.
- [x] `V1-24` Execute `make test` in ticket worktree and capture exit code/output. Test: failing fixture repo returns non-zero and stores output.
- [x] `V1-25` Success path: fast-forward merge to master and move ticket to `done/`. Test: passing fixture ends with ticket in `done/`.
- [x] `V1-26` Failure path: move ticket back to `open/` and append failure notes. Test: failing fixture reopens ticket with failure note text.

- [x] `V1-27` Add master-health gate before assigning new work. Test: with red master state, scheduler does not pick open tickets.
- [x] `V1-28` Add global halt behavior while master is red. Test: orchestrator remains idle until master health is restored.

- [x] `V1-29` Implement `status` command to report open/in-progress/done counts and active agent info. Test: CLI snapshot test for sample plan state.
- [x] `V1-30` Implement `worktrees` command to list worktree path, ticket ID, and branch. Test: CLI output includes all active worktrees.
- [x] `V1-31` Implement `plan` command: interactive multi-turn REPL (`scriptorium plan`) and one-shot path (`scriptorium plan <prompt>`). Both owned by `scriptorium plan`; spec.md is the only artifact either mode touches. Test: mocked architect update writes and commits new spec; interactive session commits on change and skips commit when spec unchanged; slash commands do not invoke runner.

- [x] `V1-32` Add invariant test: each ticket exists in exactly one state directory. Test: fixture with duplicated ticket fails validation.
- [x] `V1-33` Add invariant test: every state transition is exactly one commit authored by orchestrator. Test: transition audit test passes.
- [x] `V1-34` Add invariant test: no partial ticket moves on failure. Test: simulated crash leaves ticket in prior valid state.
- [x] `V1-35` Add bounded V1 happy-path workflow test (`spec -> areas -> tickets -> done`) with controlled runners. Test: one fixture repo completes full flow in a deterministic harness.

## Final Steps To Close V1

These are the only remaining items before the run loop can drive the full cycle unattended.

**Design decision (already settled):** Architect and Manager write files directly into the
plan worktree using their native file tools, exactly as the Coding Agent and `scriptorium plan`
do. No structured response parsing. After the agent exits, the orchestrator reads what
appeared in `areas/` or `tickets/open/` and commits it. This is consistent with the rest of
the system and avoids fragile output parsing.

- [x] `V1-36` Add idle-on-empty-spec guard to run loop: if `spec.md` is missing or contains
  only the placeholder text, log `WAITING: no spec — run 'scriptorium plan'` and skip all
  work assignment for that tick. Test: tick with blank spec produces no new commits and no
  agent invocations.

- [x] `V1-37` Implement `runArchitectAreas(repoPath)`: open plan worktree, build architect
  prompt with current spec, run agent with plan worktree as `workingDir` (agent writes area
  files directly under `areas/`), then read and commit whatever was written. Wire into
  `runOrchestratorLoop` as step 2 (after spec guard, before ticket assignment). Test: mocked
  runner writes area files; call produces area commit on plan branch.

- [x] `V1-38` Implement `runManagerTickets(repoPath)`: for each area with no open or
  in-progress tickets, build manager prompt with area content, run agent with plan worktree
  as `workingDir` (agent writes ticket files directly under `tickets/open/`), then read and
  commit whatever was written. Wire into `runOrchestratorLoop` as step 3. Test: mocked runner
  writes ticket files; call produces ticket commit on plan branch.

- [x] `V1-39` Update `runOrchestratorLoop` to call steps in order: spec guard → area
  generation → ticket generation → ticket assignment + execution → merge queue. Test:
  `runOrchestratorForTicks` with a populated spec and mocked Architect/Manager drives the
  full cycle (spec → areas → tickets → done) in one bounded run.

## Codex Automation Plan (No tmux, Codex First)

The codex harness plan below refines `V1-20` and related execution work. Scope is codex-only for now, with a clean path to add claude later.

Testing split for this plan:
- `make test` runs local unit tests only (`tests/test_*.nim`) and should not require API keys.
- `make integration-test` runs real Codex integration tests (`tests/integration_*.nim`) and requires codex plus valid auth (API keys or local OAuth login/auth file).

- [x] `CA-01` Create `src/scriptorium/harness_codex.nim` with `CodexRunRequest`, `CodexRunResult`, and `runCodex*(request)` API. Test: `nim check src/scriptorium/harness_codex.nim`.
- [x] `CA-02` Run codex as a direct child process from Nim (`startProcess`) with prompt on stdin (non-interactive one-shot). Test: fake codex binary receives stdin prompt and exits successfully.
- [x] `CA-03` Standardize codex command shape: `codex exec --json --output-last-message <file> --cd <worktree> --model <model> --dangerously-bypass-approvals-and-sandbox -`. Test: command builder unit test matches exact arg order.
- [x] `CA-04` Capture and persist raw codex JSONL stream to `.scriptorium/logs/<ticket>/<attempt>.jsonl`. Test: run creates log file with non-empty content.
- [x] `CA-05` Persist final agent message via `--output-last-message` and load it into `CodexRunResult`. Test: output file content is returned by harness result.
- [x] `CA-06` Add watchdog timers: no-output timeout and hard runtime timeout; on timeout kill process and return structured failure. Test: fake stalled codex process is killed and flagged as timeout.
- [x] `CA-07` Add bounded retry policy (for example max 2-3 attempts) with continuation prompt context. Test: first failed attempt + second success returns success with attempt count = 2.
- [x] `CA-08` Add unit test coverage for codex harness with fake/stub codex process (success, non-zero exit, malformed output, timeout). Test: `make test` passes without network/API keys.
- [x] `CA-09` Add integration tests in `tests/integration_*.nim` that run real codex on low-cost models (for example `gpt-5.1-codex-mini`). Test: `make integration-test` executes real codex and fails fast when codex binary or valid auth is missing.
- [x] `CA-10` Integrate codex harness into orchestrator ticket execution path after assignment (`V1-20`), storing run summary in ticket notes. Test: integration fixture shows ticket note appended with codex run result.
- [x] `CA-11` Keep backend abstraction ready for future claude support (`runAgent` interface), but implement only codex backend now. Test: orchestrator execution path compiles against interface with codex as active implementation.

## Legacy Integration Batch (Completed, Not Sufficient)

These tests are useful and should stay, but they are not full live MCP end-to-end coverage.

- [x] `IT-01` Agent-to-queue fixture coverage with controlled runners.
- [x] `IT-02` Queue success with real branch merge.
- [x] `IT-03` Queue failure with test failure.
- [x] `IT-04` Single-flight queue ordering with two pending items.
- [x] `IT-05` Merge conflict handling path.
- [x] `IT-06` Orchestrator tick ordering integration via `runOrchestratorForTicks`.
- [x] `IT-07` Strict integration prerequisites behavior.
- [x] `IT-08` Recovery/idempotence after interrupted queue processing.
- [x] `IT-09` Red-master assignment gate behavior.
- [x] `IT-10` Global red-master halt and recovery behavior.

## Required Live Integration Batch (Mandatory, No Fakes, No Skips)

These tests are required to claim real integration coverage for MCP completion signaling.

- [ ] `IT-LIVE-01` Real MCP transport test for orchestrator tool exposure.
  Test: start `createOrchestratorServer` on a real port, call `/mcp` over HTTP JSON-RPC, assert `tools/list` includes `submit_pr`, call `tools/call`, and verify `consumeSubmitPrSummary()` returns the submitted summary.
- [ ] `IT-LIVE-02` Real Codex MCP tool-calling integration.
  Test: run real `runCodex` with `mcpEndpoint` configured to a live orchestrator MCP server; prompt codex to call `submit_pr` with a unique nonce; assert nonce is captured by `consumeSubmitPrSummary()`.
- [ ] `IT-LIVE-03` Real orchestrator daemon end-to-end runtime integration.
  Test: run real `scriptorium run` (not `runOrchestratorForTicks`) on a fixture repo; verify ticket lifecycle advances through assignment, coding, merge queue, and `done` based on live `submit_pr` tool-calling.
- [ ] `IT-LIVE-04` Real daemon negative integration for missing `submit_pr`.
  Test: run real orchestrator path where coding attempt does not call `submit_pr`; assert no merge queue item is enqueued and ticket remains in-progress/open per scheduler behavior.
- [ ] `IT-LIVE-05` Integration execution policy enforcement.
  Test policy: all `tests/integration_*.nim` run under `make integration-test` with no conditional skip logic and no fake/mocked core integrations (codex, MCP HTTP, git merge path).
